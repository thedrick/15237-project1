<html>
<title> 15-237 Project 1 </title>
<style>
#canvas {
  margin: 0 auto;
  text-align: center;
  display: block;
}
</style>
  <canvas id="canvas" width="1000", height="600", style="border:1px solid #000000">
  </canvas>
  <script>
  window.onload = function() {
    App();
  }
  
  var App = function() {
    var canvas = document.getElementById("canvas");
    var ctx = canvas.getContext("2d");
    var cursor;
    var characterSet = [];
    
    // Load the tilesets
    var tileset = new Image();
    tileset.src = "./resources/16tiles.png";
    tileset.onload = function() {
      loadmap();
    };
    
    var characters = new Image();
    characters.src = "./resources/characters.png";
    characters.onload = function() {
      drawCharacters();
    };
    
    // tile constants
    var tileH = 40;
    var tileW = 40;
    var tileSize = 16;
    
    // characters constants
    var charH = 36;
    var charW = 32;
    var charWoffset = 3;
    var charHoffset = 2;
    
    // Create a gameboard
    var grid = [['GG', 'GG', 'GG', 'RP', 'RP', 'GG', 'GG', 'PL', 'PB', 'PC', 'PC', 'PC', 'PR', 'GG', 'PL', 'DN', 'DN', 'PR', 'RP', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG'],
                ['GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'PL', 'DN', 'PR', 'GG', 'GG', 'GG', 'GG', 'GG', 'DG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG'],
                ['GG', 'GG', 'DG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'PL', 'DN', 'PR', 'GG', 'GG', 'GG', 'RP', 'DG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG'],
                ['GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'TG', 'GG', 'PL', 'DN', 'DN', 'PR', 'GG', 'GG', 'GG', 'RP', 'DG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG'],
                ['GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'PL', 'DN', 'PR', 'TG', 'GG', 'GG', 'GG', 'DG', 'GG', 'GG', 'LF', 'GG', 'GG', 'SF', 'GG', 'GG', 'GG'],
                ['GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'PL', 'DN', 'DN', 'PR', 'TG', 'BG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'LF', 'GG', 'GG'],
                ['GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'PL', 'DN', 'DN', 'PR', 'GG', 'GG', 'GG', 'GG', 'RP', 'GG', 'GG', 'GG', 'GG', 'SF', 'SF', 'GG', 'LF', 'GG'],
                ['GG', 'GG', 'GG', 'GG', 'GG', 'TG', 'TG', 'PL', 'DN', 'PR', 'GG', 'GG', 'GG', 'GG', 'RP', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'SF', 'GG', 'GG'],
                ['GG', 'GG', 'GG', 'GG', 'GG', 'TG', 'BG', 'PL', 'DN', 'DN', 'PR', 'GG', 'GG', 'GG', 'BG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG'],
                ['GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'BG', 'TG', 'PL', 'DN', 'DN', 'DN', 'PR', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'DG', 'GG', 'GG'],
                ['GG', 'TG', 'GG', 'TG', 'GG', 'GG', 'GG', 'BG', 'GG', 'GG', 'PL', 'DN', 'PR', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'LF', 'GG', 'GG', 'GG', 'GG', 'GG'],
                ['GG', 'GG', 'GG', 'GG', 'GG', 'TG', 'GG', 'GG', 'GG', 'GG', 'PL', 'DN', 'DN', 'DN', 'PR', 'GG', 'GG', 'GG', 'SF', 'DG', 'GG', 'GG', 'GG', 'GG', 'GG'],
                ['GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'PL', 'DN', 'DN', 'PR', 'GG', 'SF', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG'],
                ['TG', 'BG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'PL', 'DN', 'PR', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG'],
                ['TG', 'TG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'PL', 'DN', 'PR', 'GG', 'GG', 'GG', 'SF', 'GG', 'GG', 'GG', 'GG', 'GG']];
    console.log(grid);
    var drawTile = function(i,j) {
      var x = 0;
      var y = 0;
      switch(grid[j][i]) {
        case 'GG':
          x = 1;
          break;
        case 'TG':
          x = 1;
          y = 2;
          break;
        case 'BG':
          x = 2;
          y = 2;
          break;
        case 'SF':
          x = 1;
          y = 1;
          break;
        case 'LF':
          x = 2;
          y = 1;
          break;
        case 'DG':
          x = 1;
          y = 6;
          break;
        case 'RP':
          x = 2;
          break;
        case 'PA':
          x = 5;
          break;
        case 'PB':
          x = 6;
          break;
        case 'PC':
          x = 7;
          break;
        case 'PL':
          x = 5;
          y = 2;
          break;
        case 'DN':
          x = 4;
          y = 2;
          break;
        case 'PR':
          x = 6;
          y = 2;
          break;
        default:
          break;
      }
      ctx.drawImage(tileset, x*tileSize, y*tileSize, tileSize, tileSize, tileW*i, tileH*j, tileW, tileH);
    }
    var loadmap = function() {
      var x = 0;
      var y = 0;
      for (i = 0; i < grid[0].length; i++) {
        for (j = 0; j < grid.length; j++) {
          drawTile(i,j);
        }
      }
      var movementRange = 3;
      ctx.fillStyle = "rgba(15,150,255, 0.7)";
    }
    
    var drawMovementSquares = function(n, xLoc, yLoc) {
      if (n === 0) {
        ctx.fillRect(tileW * xLoc, tileH * yLoc, 37, 37);
      } else {
        ctx.fillRect(tileW * xLoc, tileH * yLoc, 37, 37);
        drawMovementSquares(n-1, xLoc - 1, yLoc);
        drawMovementSquares(n-1, xLoc + 1, yLoc);
        drawMovementSquares(n-1, xLoc, yLoc + 1);
        drawMovementSquares(n-1, xLoc, yLoc - 1);
      }
    }
    
    var drawCharacters = function () {
      
      ctx.drawImage(characters, charW, charH * 2, charW, charH, 40 * 3 + 3, 40 * 4, charW, charH);
    }
    
    // Character classes
    var Archer = function(x, y) {
      this.x = x;
      this.y = y;
      this.movementRange = 4;
      this.attackRange = 4;
      this.hp = 50;
      this.mp = 0;
      this.draw = function() {
        ctx.drawImage(characters, charW * 13, charH * 2, charW, charH, tileW * x + charWoffset, tileH * y + charHoffset, charW, charH);
      }
      this.isSelected = false;
    }
    
    var Warrior = function(x, y) {
      this.x = x;
      this.y = y;
      this.movementRange = 3;
      this.attackRange = 1;
      this.hp = 75;
      this.mp = 0;
      this.draw = function() {
        ctx.drawImage(characters, charW * 1, charH * 2, charW, charH, tileW *x + charWoffset, tileH * y + charHoffset, charW, charH);
      }
      this.isSelected = false;
    }
    
    var Mage = function(x, y) {
      this.x = x;
      this.y = y;
      this.movementRange = 3;
      this.attackRange = 1;
      this.hp = 45;
      this.mp = 40;
      this.draw = function() {
        ctx.drawImage(characters, charW * 4, charH * 6, charW, charH, tileW *x + charWoffset, tileH * y + charHoffset, charW, charH);
      }
      this.isSelected = false;
    }
    
    var Ninja = function(x, y) {
      this.x = x;
      this.y = y;
      this.movementRange = 5;
      this.attackRange = 1;
      this.hp = 45;
      this.mp = 20;
      this.draw = function() {
        ctx.drawImage(characters, charW * 10, charH * 2, charW, charH, tileW *x + charWoffset, tileH * y + charHoffset, charW, charH);
      }
      this.isSelected = false;
    }
    
    var Cleric = function(x, y) {
      this.x = x;
      this.y = y;
      this.movementRange = 3;
      this.attackRange = 1;
      this.hp = 45;
      this.mp = 40;
      this.draw = function() {
        ctx.drawImage(characters, charW * 7, charH * 6, charW, charH, tileW *x + charWoffset, tileH * y + charHoffset, charW, charH);
      }
      this.isSelected = false;
    }
    
    characterSet.push(new Archer(2,3));
    characterSet.push(new Cleric(2,2));
    characterSet.push(new Ninja(3,2));
    characterSet.push(new Mage(1,4));
    characterSet.push(new Warrior(3,4));
    
    var Cursor = function(x,y) {
      this.x = x;
      this.y = y;
      this.draw = function() {
        ctx.strokeStyle = "white"
        ctx.lineWidth = 2;
        ctx.strokeRect(tileW * this.x, tileH * this.y, tileW - 2, tileH - 2);
      }
      this.moveLeft = function() {
        if (this.x > 0) {
          this.x--;
        }
      }
      this.moveRight = function() {
        if (this.x < grid[0].length - 1) {
          this.x++;
        }
      }
      this.moveUp = function() {
        if (this.y > 0) {
          this.y--;
        }
      }
      this.moveDown = function() {
        if (this.y < grid.length - 1) {
          this.y++;
        }
      }
    }
    
    cursor = new Cursor(0,0);
    
    var keyboardHandler = function(e) {
      switch(e.keyCode) {
        case 37:
          cursor.moveLeft();
          break;
        case 38:
          cursor.moveUp();
          break;
        case 39:
          cursor.moveRight();
          break;
        case 40:
          cursor.moveDown();
          break;
      }
    };
    canvas.addEventListener('keydown', keyboardHandler, true);
    canvas.setAttribute('tabindex', '0');
    canvas.focus();
    
    var checkForCharacter = function() {
      characterSet.forEach(function(c) {
        if (cursor.x === c.x && cursor.y === c.y) {
          drawMovementSquares(c.movementRange, c.x, c.y);
        }
      });
    }
    
    var draw = function() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      loadmap();
      drawCharacters();
      checkForCharacter();
      characterSet.forEach(function(c) {
        drawTile(c.x, c.y);
        character.isSelected ? c.draw() : ;
        c.draw();
      });
      cursor.draw();
    }
    
    setInterval(draw, 1000 / 30);
  }
  </script>  
</html>