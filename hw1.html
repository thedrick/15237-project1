<html>
<title> 15-237 Project 1 </title>
<head> <link href='http://fonts.googleapis.com/css?family=Croissant+One' rel='stylesheet' type='text/css'> </head>
<style>
#canvas {
  margin: 0 auto;
  text-align: center;
  display: block;
}
</style>
  <canvas id="canvas" width="1000", height="600", style="border:1px solid #000000">
  </canvas>
  <script>
  window.onload = function() {
    App();
  }
  
  var App = function() {
    var canvas = document.getElementById("canvas");
    var ctx = canvas.getContext("2d");
    var cursor;
    var characterSet = [];
    
    var selectedCharacter = null;
    var actionMenuShowing = false;
    var characterIsMoving = false;
    var characterIsAttacking = false;
    var currentActionItem = 0;
    
    // Load the tilesets
    var tileset = new Image();
    tileset.src = "./resources/16tiles.png";
    tileset.onload = function() {
      loadmap();
    };
    
    var characters = new Image();
    characters.src = "./resources/characters.png";
    
    // tile constants
    var tileH = 40;
    var tileW = 40;
    var tileSize = 16;
    
    // characters constants
    var charH = 36;
    var charW = 32;
    var charWoffset = 3;
    var charHoffset = 2;
    
    // Create a gameboard
    var grid = [['GG', 'GG', 'GG', 'RP', 'RP', 'GG', 'GG', 'PL', 'PB', 'PC', 'PC', 'PC', 'PR', 'GG', 'PL', 'DN', 'DN', 'PR', 'RP', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG'],
                ['GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'PL', 'DN', 'PR', 'GG', 'GG', 'GG', 'GG', 'GG', 'DG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG'],
                ['GG', 'GG', 'DG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'PL', 'DN', 'PR', 'GG', 'GG', 'GG', 'RP', 'DG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG'],
                ['GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'TG', 'GG', 'PL', 'DN', 'DN', 'PR', 'GG', 'GG', 'GG', 'RP', 'DG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG'],
                ['GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'PL', 'DN', 'PR', 'TG', 'GG', 'GG', 'GG', 'DG', 'GG', 'GG', 'LF', 'GG', 'GG', 'SF', 'GG', 'GG', 'GG'],
                ['GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'PL', 'DN', 'DN', 'PR', 'TG', 'BG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'LF', 'GG', 'GG'],
                ['GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'PL', 'DN', 'DN', 'PR', 'GG', 'GG', 'GG', 'GG', 'RP', 'GG', 'GG', 'GG', 'GG', 'SF', 'SF', 'GG', 'LF', 'GG'],
                ['GG', 'GG', 'GG', 'GG', 'GG', 'TG', 'TG', 'PL', 'DN', 'PR', 'GG', 'GG', 'GG', 'GG', 'RP', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'SF', 'GG', 'GG'],
                ['GG', 'GG', 'GG', 'GG', 'GG', 'TG', 'BG', 'PL', 'DN', 'DN', 'PR', 'GG', 'GG', 'GG', 'BG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG'],
                ['GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'BG', 'TG', 'PL', 'DN', 'DN', 'DN', 'PR', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'DG', 'GG', 'GG'],
                ['GG', 'TG', 'GG', 'TG', 'GG', 'GG', 'GG', 'BG', 'GG', 'GG', 'PL', 'DN', 'PR', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'LF', 'GG', 'GG', 'GG', 'GG', 'GG'],
                ['GG', 'GG', 'GG', 'GG', 'GG', 'TG', 'GG', 'GG', 'GG', 'GG', 'PL', 'DN', 'DN', 'DN', 'PR', 'GG', 'GG', 'GG', 'SF', 'DG', 'GG', 'GG', 'GG', 'GG', 'GG'],
                ['GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'PL', 'DN', 'DN', 'PR', 'GG', 'SF', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG'],
                ['TG', 'BG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'PL', 'DN', 'PR', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG'],
                ['TG', 'TG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'GG', 'PL', 'DN', 'PR', 'GG', 'GG', 'GG', 'SF', 'GG', 'GG', 'GG', 'GG', 'GG']];
    var drawTile = function(i,j) {
      var x = 0;
      var y = 0;
      switch(grid[j][i]) {
        case 'GG':
          x = 1;
          break;
        case 'TG':
          x = 1;
          y = 2;
          break;
        case 'BG':
          x = 2;
          y = 2;
          break;
        case 'SF':
          x = 1;
          y = 1;
          break;
        case 'LF':
          x = 2;
          y = 1;
          break;
        case 'DG':
          x = 1;
          y = 6;
          break;
        case 'RP':
          x = 2;
          break;
        case 'PA':
          x = 5;
          break;
        case 'PB':
          x = 6;
          break;
        case 'PC':
          x = 7;
          break;
        case 'PL':
          x = 5;
          y = 2;
          break;
        case 'DN':
          x = 4;
          y = 2;
          break;
        case 'PR':
          x = 6;
          y = 2;
          break;
        default:
          break;
      }
      ctx.drawImage(tileset, x*tileSize, y*tileSize, tileSize, tileSize, tileW*i, tileH*j, tileW, tileH);
    }
    
    var drawActionMenuArrow = function() {
      var x = 20;
      var y = 0;
      switch (currentActionItem) {
        case 0:
          y = canvas.height - 145;
          break;
        case 1:
          y = canvas.height - 95;
          break;
        case 2:
          y = canvas.height - 45;
          break;
        default:
          y = canvas.height - 145;
          break;
      }
      ctx.fillStyle = "black";
      ctx.beginPath();
      ctx.moveTo(x , y)
      ctx.lineTo(x, y + 16);
      ctx.lineTo(x + 16, y + 8);
      ctx.closePath();
      ctx.fill();
    }
    
    var drawMovementSquares = function(n, xLoc, yLoc) {
      ctx.fillStyle = "rgba(15,150,255, 0.7)";
      if (n === 0) {
        ctx.fillRect(tileW * xLoc, tileH * yLoc, 37, 37);
      } else {
        ctx.fillRect(tileW * xLoc, tileH * yLoc, 37, 37);
        drawMovementSquares(n-1, xLoc - 1, yLoc);
        drawMovementSquares(n-1, xLoc + 1, yLoc);
        drawMovementSquares(n-1, xLoc, yLoc + 1);
        drawMovementSquares(n-1, xLoc, yLoc - 1);
      }
    }
    
    var drawAttackSquares = function(n, xLoc, yLoc) {
      ctx.fillStyle = "rgba(20,173,0, 0.7)";
      if (n === 0) {
        ctx.fillRect(tileW * xLoc, tileH * yLoc, 37, 37);
      } else {
        ctx.fillRect(tileW * xLoc, tileH * yLoc, 37, 37);
        drawAttackSquares(n-1, xLoc - 1, yLoc);
        drawAttackSquares(n-1, xLoc + 1, yLoc);
        drawAttackSquares(n-1, xLoc, yLoc + 1);
        drawAttackSquares(n-1, xLoc, yLoc - 1);
      }
    }
    
    var drawActionMenu = function(c) {
      if (currentActionItem === 0) {
        drawMovementSquares(c.movementRange, c.x, c.y);
      } else if (currentActionItem === 1) {
        drawAttackSquares(c.attackRange, c.x, c.y);
      }
      characterSet.forEach(function(c) {
        if (currentActionItem == 0) {
          drawTile(c.x, c.y);
        }
        c.draw();
      });
      ctx.fillStyle = "rgba(217, 150, 35, 0.6)";
      ctx.fillRect(10, canvas.height - 160, 135, 150);
      ctx.font = "24px Croissant One";
      ctx.fillStyle = "black";
      ctx.textAlign = "center"
      var x = 150 / 2 + 10;
      ctx.fillText("Move", x, canvas.height - 130);
      ctx.fillText("Attack", x, canvas.height - 80);
      ctx.fillText("Wait", x, canvas.height - 30);
      drawActionMenuArrow();
      actionMenuShowing = true;
    }
    
    var drawStatusBox = function(c) {
      ctx.fillStyle = "rgba(217, 150, 35, 0.6)";
      ctx.fillRect(canvas.width - 300, 10, 290, 80);
      ctx.font = "16px Croissant One";
      ctx.fillStyle = "rgba(0,0,0,.7)";
      ctx.textAlign = "left";
      // Drop shadow
      ctx.fillText("Name:    " + c.name, canvas.width - 292, 31);
      ctx.fillText("HP:", canvas.width - 267, 56);
      ctx.fillText("MP:", canvas.width - 267, 81);
      ctx.fillStyle = "white";
      ctx.fillText("Name:    " + c.name, canvas.width - 290, 30);
      ctx.fillText("HP:", canvas.width - 265, 55);
      ctx.fillText("MP:", canvas.width - 265, 80);
      ctx.strokeStyle = "black";
      ctx.strokeRect(canvas.width - 215, 45, 180, 10);
      ctx.strokeRect(canvas.width - 215, 70, 180, 10);
      ctx.fillStyle = "green";
      ctx.fillRect(canvas.width - 215, 45, 180 * (c.hp / c.maxHp), 10);
      ctx.fillStyle = "rgb(28, 95, 212)";
      ctx.fillRect(canvas.width - 215, 70, 180 * (c.mp / c.maxMp), 10);
    }
    
    var loadmap = function() {
      var x = 0;
      var y = 0;
      for (i = 0; i < grid[0].length; i++) {
        for (j = 0; j < grid.length; j++) {
          drawTile(i,j);
        }
      }
      var movementRange = 3;
    }
    
    // Character classes
    var Archer = function(x, y) {
      this.x = x;
      this.y = y;
      this.movementRange = 4;
      this.attackRange = 4;
      this.hp = 50;
      this.maxHp = 50;
      this.mp = 0;
      this.maxMp = 1;
      this.name = "Archer";
      this.draw = function() {
        ctx.drawImage(characters, charW * 13, charH * 2, charW, charH, tileW * this.x + charWoffset, tileH * this.y + charHoffset, charW, charH);
      }
      this.isSelected = false;
      this.isMoving = false;
      this.isAttacking = false;
    }
    
    var Warrior = function(x, y) {
      this.x = x;
      this.y = y;
      this.movementRange = 3;
      this.attackRange = 1;
      this.hp = 75;
      this.maxHp = 75;
      this.mp = 0;
      this.maxMp = 1;
      this.name = "Warrior";
      this.draw = function() {
        ctx.drawImage(characters, charW * 1, charH * 2, charW, charH, tileW * this.x + charWoffset, tileH * this.y + charHoffset, charW, charH);
      }
      this.isSelected = false;
      this.isMoving = false;
      this.isAttacking = false;
    }
    
    var Mage = function(x, y) {
      this.x = x;
      this.y = y;
      this.movementRange = 3;
      this.attackRange = 1;
      this.hp = 45;
      this.maxHp = 45;
      this.mp = 40;
      this.maxMp = 40;
      this.name = "Mage";
      this.draw = function() {
        ctx.drawImage(characters, charW * 4, charH * 6, charW, charH, tileW * this.x + charWoffset, tileH * this.y + charHoffset, charW, charH);
      }
      this.isSelected = false;
      this.isMoving = false;
      this.isAttacking = false;
    }
    
    var Ninja = function(x, y) {
      this.x = x;
      this.y = y;
      this.movementRange = 5;
      this.attackRange = 1;
      this.hp = 45;
      this.maxHp = 45;
      this.mp = 20;
      this.maxMp = 20;
      this.name = "Ninja";
      this.draw = function() {
        ctx.drawImage(characters, charW * 10, charH * 2, charW, charH, tileW * this.x + charWoffset, tileH * this.y + charHoffset, charW, charH);
      }
      this.isSelected = false;
      this.isMoving = false;
      this.isAttacking = false;
    }
    
    var Cleric = function(x, y) {
      this.x = x;
      this.y = y;
      this.movementRange = 3;
      this.attackRange = 1;
      this.hp = 45;
      this.maxHp = 45;
      this.mp = 40;
      this.maxMp = 40;
      this.name = "Cleric";
      this.draw = function() {
        ctx.drawImage(characters, charW * 7, charH * 6, charW, charH, tileW * this.x + charWoffset, tileH * this.y + charHoffset, charW, charH);
      }
      this.isSelected = false;
      this.isMoving = false;
      this.isAttacking = false;
    }
    
    characterSet.push(new Archer(2,3));
    characterSet.push(new Cleric(2,2));
    characterSet.push(new Ninja(3,2));
    characterSet.push(new Mage(1,4));
    characterSet.push(new Warrior(3,4));
    
    var Cursor = function(x,y) {
      this.x = x;
      this.y = y;
      this.draw = function() {
        ctx.strokeStyle = "white"
        ctx.lineWidth = 2;
        ctx.strokeRect(tileW * this.x, tileH * this.y, tileW - 2, tileH - 2);
      }
      this.moveLeft = function() {
        if (this.x > 0) {
          this.x--;
        }
      }
      this.moveRight = function() {
        if (this.x < grid[0].length - 1) {
          this.x++;
        }
      }
      this.moveUp = function() {
        if (this.y > 0) {
          this.y--;
        }
      }
      this.moveDown = function() {
        if (this.y < grid.length - 1) {
          this.y++;
        }
      }
    }
    
    cursor = new Cursor(0,0); 
    
    var madeActionSelection = function(c) {
      switch (currentActionItem) {
        case 0:
          c.isMoving = true;
          characterIsMoving = true;
          break;
        case 1:
          c.isAttacking = true;
          characterIsAttacking = true;
          break;
        case 2:
          break;
        default:
          break;
      }
    }
    
    var handleActionMenu = function(e) {
      switch (e.keyCode) {
        case 38:
          if (currentActionItem > 0) currentActionItem--;
          break;
        case 40:
          if (currentActionItem < 2) currentActionItem++;
          break;
        case 13:
          characterSet.forEach(function (c) {
            if (cursor.x === c.x && cursor.y === c.y) {
              actionMenuShowing = false;
              c.isSelected = true;
              madeActionSelection(c);
            }
          });
          break;
      }
    }
    
    var alreadyOccupied = function(newX, newY) {
      isOccupied = false;
      characterSet.forEach(function(c) {
        if (c.x === newX && c.y === newY) {
          isOccupied = true;
        }
      });
      return isOccupied;
    }
    
    var characterAtLocation = function(xLoc, yLoc) {
      var charAtLoc = null;
      characterSet.forEach(function(c) {
        if (c.x === xLoc && c.y === yLoc) {
          charAtLoc = c;
        }
      });
      return charAtLoc;
    }
    
    var handleCharacterMoving = function(e) {
      var curX = cursor.x;
      var curY = cursor.y;
      switch(e.keyCode) {
        case 37:
          cursor.moveLeft();
          break;
        case 38:
          cursor.moveUp();
          break;
        case 39:
          cursor.moveRight();
          break;
        case 40:
          cursor.moveDown();
          break;
        case 13:
          if (!alreadyOccupied(curX, curY)) {
            selectedCharacter.x = cursor.x;
            selectedCharacter.y = cursor.y;
            selectedCharacter.isSelected = false;
            selectedCharacter = null;
            actionMenuShowing = false;
            characterIsMoving = false;
            characterIsAttacking = false;
            return;
          }
          break;
      }
      var dist = Math.abs(cursor.x - selectedCharacter.x) + Math.abs(cursor.y - selectedCharacter.y);
      if (dist > selectedCharacter.movementRange) {
        cursor.x = curX;
        cursor.y = curY;
      }
    };
    
    var handleCharacterAttacking = function(e) {
      var curX = cursor.x;
      var curY = cursor.y;
      switch(e.keyCode) {
        case 37:
          cursor.moveLeft();
          break;
        case 38:
          cursor.moveUp();
          break;
        case 39:
          cursor.moveRight();
          break;
        case 40:
          cursor.moveDown();
          break;
        case 13:
          // cannot attack yourself
          if (curX === selectedCharacter.x && curY === selectedCharacter.y) 
            return;
          // there is someone there we can attack!
          if (alreadyOccupied(curX, curY)) {
            var attackedPlayer = characterAtLocation(curX, curY);
            console.log(selectedCharacter.name + " attacked " + attackedPlayer.name);
            selectedCharacter.isSelected = false;
            selectedCharacter = null;
            actionMenuShowing = false;
            characterIsMoving = false;
            characterIsAttacking = false;
            return;
          }
          break;
      }
      var dist = Math.abs(cursor.x - selectedCharacter.x) + Math.abs(cursor.y - selectedCharacter.y);
      if (dist > selectedCharacter.attackRange) {
        cursor.x = curX;
        cursor.y = curY;
      }
    };
    
    var handleCursorMovement = function(e) {
      switch(e.keyCode) {
        case 37:
          cursor.moveLeft();
          break;
        case 38:
          cursor.moveUp();
          break;
        case 39:
          cursor.moveRight();
          break;
        case 40:
          cursor.moveDown();
          break;
        case 13:
          characterSet.forEach(function (c) {
            if (cursor.x === c.x && cursor.y === c.y) {
              c.isSelected = true;
              actionMenuShowing = true;
              selectedCharacter = c;
            }
          });
      }
    };
    
    var keyboardHandler = function(e) {
      if (e.keyCode === 27) {
        if (selectedCharacter !== null) {
          selectedCharacter.isSelected = false;
        }
        selectedCharacter = null;
        actionMenuShowing = false;
        characterIsMoving = false;
        characterIsAttacking = false;
      } else if (actionMenuShowing) {
        handleActionMenu(e);
      } else if (characterIsMoving) {
        handleCharacterMoving(e);
      } else if (characterIsAttacking) {
        handleCharacterAttacking(e);
      } else {
        handleCursorMovement(e);
      }
    };
    
    canvas.addEventListener('keydown', keyboardHandler, true);
    canvas.setAttribute('tabindex', '0');
    canvas.focus();
    
    var draw = function() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      loadmap();
      characterSet.forEach(function(c) {
        if (c.isSelected) {
          if (actionMenuShowing) {
            drawActionMenu(c);
          } else if (characterIsMoving) {
            drawMovementSquares(c.movementRange, c.x, c.y);
          } else if (characterIsAttacking) {
            drawAttackSquares(c.attackRange, c.x, c.y);
          }
          drawStatusBox(c);
        }
        c.draw();
      });
      characterSet.forEach(function(c) {
        if (characterIsMoving) {
          drawTile(c.x, c.y);
        }
        c.draw();
      });
      cursor.draw();
    }
    
    setInterval(draw, 1000 / 30);
  }
  </script>  
</html>